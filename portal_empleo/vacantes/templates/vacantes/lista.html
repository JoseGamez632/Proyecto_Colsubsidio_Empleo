{% extends 'base.html' %}
{% load static %}

{% block titulo %}
Inicio
{% endblock %}

{% block contenido %}
<style> // Filtros Vacantes
    /* Asegurar desplazamiento en el dropdown de Select2 */
    .select2-dropdown {
        max-height: 300px !important; /* Altura máxima del dropdown */
        overflow-y: auto !important; /* Habilitar scroll vertical */
        scrollbar-width: thin !important; /* Para Firefox */
        scrollbar-color: #3498db #34495e !important; /* Color de scrollbar */
    }

    /* Estilos de scrollbar para webkit (Chrome, Safari, newer versions of Opera) */
    .select2-dropdown::-webkit-scrollbar {
        width: 8px !important; /* Ancho del scrollbar */
    }

    .select2-dropdown::-webkit-scrollbar-track {
        background: #34495e !important; /* Color de fondo del track */
    }

    .select2-dropdown::-webkit-scrollbar-thumb {
        background-color: #3498db !important; /* Color del thumb */
        border-radius: 4px !important; /* Bordes redondeados */
    }

    .select2-dropdown::-webkit-scrollbar-thumb:hover {
        background-color: #2980b9 !important; /* Color al pasar el mouse */
    }

    /* Asegurar que el contenido del dropdown sea scrollable */
    .select2-results {
        max-height: 280px !important;
        overflow-y: auto !important;
    }

    /* Mejorar la interacción táctil */
    @media (max-width: 768px) {
        .select2-dropdown {
            max-height: 50vh !important; /* 50% de la altura de la ventana en dispositivos móviles */
        }
    }

    /* Estilos personalizados para Select2 */
    .select2-container {
        width: 100% !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection {
        background-color:rgb(255, 255, 255) !important;
        border: 1px solid #343A40 !important;
        border-radius: 0.375rem !important;
        color: white !important;
        min-height: 38px !important;
    }
    
    /* Estilos para selección múltiple */
    .select2-container--bootstrap-5 .select2-selection--multiple {
        padding: 0.25rem 0.5rem !important;
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 0.25rem !important;
        min-height: 38px !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__rendered {
        display: flex !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        gap: 0.25rem !important;
        width: 100% !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__placeholder {
        color: white !important;
        opacity: 0.7 !important;
        position: absolute !important;
        left: 50% !important;
        transform: translateX(-50%) !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
        background-color: #3498db !important;
        color: white !important;
        border: none !important;
        border-radius: 0.25rem !important;
        margin: 0.1rem !important;
        padding: 0.2rem 0.5rem !important;
        display: inline-flex !important;
        align-items: center !important;
        font-size: 0.875rem !important;
        max-width: calc(100% - 0.5rem) !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
        color: white !important;
        margin-left: 0.25rem !important;
        opacity: 0.7 !important;
    }
    
    .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__display {
        max-width: 150px !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
    }
    
    /* Estilos para el dropdown */
    .select2-dropdown {
        background-color: #34495e !important;
        color: white !important;
    }
    
    .select2-results__option {
        background-color: #34495e !important;
        color: white !important;
        padding: 0.5rem !important;
    }
    
    .select2-results__option--highlighted {
        background-color: #3498db !important;
        color: white !important;
    }
    
    /* Responsividad */
    @media (max-width: 576px) {
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
            margin: 0.1rem !important;
            padding: 0.1rem 0.3rem !important;
            font-size: 0.75rem !important;
        }
    
        .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__display {
            max-width: 100px !important;
        }
    }
</style>
    
<style>
    .vacante-card.selected {
    box-shadow: 0 0 10px 3px rgba(40, 167, 69, 0.8);
    border: 2px solid #28a745;
    transition: all 0.3s ease-in-out;
}

    
    .descripcion-vacante {
    white-space: pre-line;
}

/* Estilos generales */
.vacante-card {
    width: 100%;
    max-width: 95%;
    word-wrap: break-word;
    overflow: hidden;
    text-align: center;
    padding: 15px;
    margin-bottom: 15px;
    background: rgba(33, 37, 41, 0.8);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
    color: white;
    position: relative;
}

.vacante-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
}

.vacante-title {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ffc107;
    margin-bottom: 10px;
    position: relative;
    z-index: 5;
}

.vacante-location {
    background-color: #ffc107;
    color: #333 !important;
    padding: 3px 6px;
    margin: 2px 0;
    display: inline-block;
    border-radius: 3px;
    font-weight: bold;
    font-size: 0.85em;
}

h1.text-warning.mb-4.fw-bold {
    font-size: 2.5rem !important;
    font-weight: bold !important;
    color: #ffc107 !important;
    text-align: center !important;
    margin-bottom: 2rem !important;
}

.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); /* Mejor ajuste en móviles */
    gap: 15px;
    padding: 10px;
}

/* Botón flotante */
.floating-button {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
    background-color: #ffc107;
    color: black;
    border-radius: 50px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.floating-button:hover {
    background-color: #ffca2c;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

/* Switch Estado de Vacante */
.switch {
    position: relative;
    display: inline-block;
    width: 86px;
    height: 30px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: red;
    transition: .4s;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 12px;
    width: 12px;
    left: 4px;
    bottom: 9px;
    background-color: white;
    transition: .4s;
}

input:checked + .slider {
    background-color: green;
}

input:checked + .slider:before {
    transform: translateX(66px);
}

.slider.round {
    border-radius: 34px;
}

.slider.round:before {
    border-radius: 50%;
}

.switch-text {
    position: absolute;
    width: 100%;
    text-align: center;
    pointer-events: none;
}

/* Filtros y descripción de vacante */
.offcanvas-header, .modal-header {
    background-color: #3d4146 !important;
    color: white !important;
}

.offcanvas-body, .modal-body {
    background-color: #343a40 !important;
    color: white !important;
}

.modal-footer {
    background-color: #3d4146 !important;
    color: white !important;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

.form-control {
    background-color:rgb(255, 255, 255) !important;
    color: white !important;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

/* Corregir color de texto en Detalles de la Vacante */
.modal-body .emoji-icon, 
.modal-body .vacante-info, 
.modal-body .vacante-info span, 
.modal-body .list-group-item.bg-transparent.border-secondary {
    color: white !important;
} 

/* Tutorial Modal */
.tutorial-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    animation: fadeIn 0.3s ease-in-out;
    overflow-y: auto;
    padding: 40px 20px;
}

.tutorial-content {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(33, 37, 41, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    color: white;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    padding: 30px;
}

.tutorial-note {
    background: rgba(255, 193, 7, 0.1);
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #ffc107;
    margin-top: 20px;
    color: white;
}

.tutorial-step {
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(255, 255, 255, 0.05);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 10px;
}

.step-number {
    background: #ffc107;
    color: black;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 16px;
    flex-shrink: 0;
}

.tutorial-footer {
    padding: 20px;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* Checkbox personalizado */
.selection-checkbox {
    display: none;
}

.selection-checkbox + label {
    display: inline-block;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    background-color: #ffc107;
    color: black;
    border-radius: 8px;
    border: 2px solid #ffc107;
    cursor: pointer;
    transition: all 0.3s ease;
}

.selection-checkbox:checked + label {
    background-color: #28a745;
    border-color: #28a745;
    color: white;
}

.selection-checkbox + label:after {
    content: "Click para aplicar";
}

.selection-checkbox:checked + label:after {
    content: "Aplicado";
}
/* Estilos para Select2 */
.select2-container--bootstrap4 .select2-selection--multiple {
    background-color: RGB(73, 80, 87);
    border: 1px solid RGB(73, 80, 87);
    border-radius: 0.25rem;
    min-height: 38px;
}

.select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice {
    background-color: #ffc107; /* Amarillo */
    border: 1px solid #e0a800;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    margin-right: 0.5rem;
    margin-top: 0.25rem;
    color: #212529; /* Negro */
    font-weight: 500;
}

.select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove {
    color: #212529;
    margin-right: 0.25rem;
    font-weight: bold;
}

.select2-container--bootstrap4 .select2-selection--multiple .select2-selection__choice__remove:hover {
    color: #000;
}

.select2-container--bootstrap4 .select2-dropdown {
    border-color: RGB(73, 80, 87);
    border-radius: 0.25rem;
    background-color: #f8f9fa;
}

.select2-container--bootstrap4 .select2-results__option--highlighted[aria-selected] {
    background-color: #ffc107;
    color: #212529;
}

.select2-container--bootstrap4 .select2-results__option[aria-selected=true] {
    background-color: #ffc107;
    color: #212529;
}

/* Estilos para la sección de filtros activos */
#active-filters {
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 0.25rem;
    padding: 0.75rem;
    margin-bottom: 1.5rem;
}

.filter-badge {
    display: inline-block;
    padding: 0.5rem 0.75rem;
    font-size: 0.875rem;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    background-color: #ffc107;
    color: #212529;
    font-weight: 500;
    border-radius: 50px;
}

.filter-badge .remove-filter {
    cursor: pointer;
    margin-left: 5px;
}

.filter-badge .remove-filter:hover {
    color: #dc3545;
}

/* Estilo para los formularios y contenedores */
.offcanvas-body {
    padding: 1.5rem;
}

.form-control, .multiselect {
    background-color: #FFFFFF;
    border: 1px solidrgb(64, 64, 65);
}

.form-label {
    font-weight: 500;
    margin-bottom: 0.5rem;
}

/* Estilo para el encabezado de filtros activos */
#active-filters h6 {
    margin-bottom: 1rem;
    font-weight: 600;
}

/* Personalización para el contenedor de filtros */
.active-filters-container {
    max-height: 200px;
    overflow-y: auto;
    padding: 0.5rem;
    background-color: rgba(248, 249, 250, 0.1);
    border-radius: 0.25rem;
}

/* CSS para mejorar la visualización de Bootstrap-Multiselect */
.btn-group > .multiselect.dropdown-toggle {
    text-align: left;
    height: auto;
    min-height: 38px;
    white-space: normal;
    padding: 5px 12px;
    background-color: #fff;
    border: 1px solid #ced4da;
}

.btn-group > .multiselect:after {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
}

.btn-group > .multiselect.show {
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

.multiselect-container {
    width: 100%;
    padding: 5px;
    max-height: 300px;
    overflow-y: auto;
}

.multiselect-container .dropdown-item {
    padding: 5px;
}

.multiselect-container .dropdown-item label {
    cursor: pointer;
    width: 100%;
    margin: 0;
}

.multiselect-container .dropdown-item.active {
    background-color: #f8f9fa;
    color: #212529;
}

.multiselect-container .dropdown-item.active label {
    color: #212529;
}

.multiselect-selected-text {
    display: block;
    width: 100%;
    white-space: normal;
    word-wrap: break-word;
    padding-right: 15px;
}
    /* Estilo para el offcanvas */
    .offcanvas {
        max-width: 400px;
    }
    
    /* Estilos para los multiselect */
    .multiselect-improved + .btn-group {
        width: 100% !important;
    }
    
    .multiselect-improved + .btn-group > .multiselect-container {
        width: 100% !important;
        max-height: 200px;
        overflow-y: auto;
    }
    
    .multiselect-improved + .btn-group > button {
        text-align: left;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 100%;
        position: relative;
        padding-right: 25px;
    }
    
    .multiselect-container > li > a > label {
        padding: 5px 20px 5px 40px;
        white-space: normal;
        word-wrap: break-word;
    }
    
    /* Estilo para las etiquetas de selección */
    .selected-options {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 5px;
    }
    
    .option-tag {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 3px;
        padding: 2px 8px;
        margin: 2px;
        display: inline-flex;
        align-items: center;
        font-size: 0.85rem;
    }
    
    .option-tag .remove-option {
        margin-left: 5px;
        cursor: pointer;
    }
    
    /* Estilos adicionales para mejorar la visualización en el offcanvas */
    .offcanvas-body {
        padding-right: 10px;
        padding-left: 10px;
    }
    
    .filters-container::-webkit-scrollbar {
        width: 5px;
    }
    
    .filters-container::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
    }
    
    .filters-container::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 5px;
    }

</style>
{% if not user.is_authenticated %}
<div class="tutorial-modal" id="tutorialModal">
    <div class="tutorial-content">
        <div class="tutorial-header">
            <h4>✨ ¡Bienvenido al Portal de Vacantes! ✨</h4>
            <button class="tutorial-close" onclick="closeTutorial()">×</button>
        </div>
        <div class="tutorial-body">
            <div class="tutorial-step">
                <span class="step-number">1</span>
                <p>Realiza los filtros correspondientes según lo requiera tu perfil.</p>
            </div>
            <div class="tutorial-step">
                <span class="step-number">2</span>
                <p>Revisa las vacantes y ve seleccionando todas las vacantes que te interesen.</p>
            </div>
            <div class="tutorial-step">
                <span class="step-number">3</span>
                <p>Cuando finalices de seleccionar las vacantes de tu interés oprime el botón "Aplicar a # vacantes".</p>
            </div>
            <div class="tutorial-note">
                <strong>Nota:</strong> En caso de no aplicar a ninguna de las vacantes oprime el botón "Registrar mis datos" para tenerte en cuenta en futuras vacantes.
            </div>
        </div>
        <div class="tutorial-footer">
            <label class="no-show-again">
                <input type="checkbox" id="noShowAgain"> No mostrar de nuevo
            </label>
            <button class="tutorial-button" onclick="closeTutorial()">¡Entendido!</button>
        </div>
    </div>
</div>
{% endif %}
{% load humanize %}
<div class="gradient-bg">
    <div class="container py-5">
        <!-- Header Section -->
        <div class="mb-5">
            <h1 class="text-warning mb-4 fw-bold">Listado de Vacantes Activas</h1>
            <div class="d-flex flex-wrap gap-2 justify-content-center">
                <div class="d-flex gap-2 w-100 justify-content-center">
                    <button type="button" class="btn btn-outline-light btn-sm" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample">
                        🔍 Filtrar Vacantes
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="clearFilters()">
                        🧹 Borrar Filtros
                    </button>
                    <button type="button" class="btn btn-outline-light btn-sm" onclick="desmarcarVacantes()">
                        ❌ Desmarcar Selección
                    </button>
                </div>
                <div class="d-flex gap-2 w-100 justify-content-center">
                    {% if request.user.is_authenticated %}
                    <a class="btn btn-outline-light btn-sm" href="{% url 'agregar_vacante' %}">
                        ➕ Agregar Vacante
                    </a>
                    <a href="{% url 'descargar_excel' %}" class="btn btn-success btn-sm"><i class="fa-solid fa-file-excel"></i> Descargar Excel Vacantes</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="mb-4" id="active-filters">
            <h6 class="text-light">✅ Filtros Activos</h6>
            <div class="active-filters-container" id="active-filters-container">
                {% for key, value in filtros.items %}
                    {% if value %}
                        {% if value is list %}
                            {% for val in value %}
                                <span class="filter-badge">
                                    {{ key|title }}: <strong>{{ val }}</strong>
                                    <span class="remove-filter" data-filter-key="{{ key }}" data-filter-value="{{ val }}">❌</span>
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="filter-badge">
                                {{ key|title }}: <strong>{{ value }}</strong>
                                <span class="remove-filter" data-filter-key="{{ key }}" data-filter-value="{{ value }}">❌</span>
                            </span>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Job Listings -->
        <div class="grid-container">
            {% for vacante in vacantes %}
            <div class="vacante-card">
                <div class="vacante-header">
                    <div class="checkbox-container">
                            <div class="vacante-info">
                            <div class="vacante-title">{{ vacante.cargo }}</div>
                            <div class="vacante-location">
    📍 
    {% if vacante.ciudad %}
        {{ vacante.ciudad }}
    {% elif vacante.departamento %}
        {{ vacante.departamento }}
    {% else %}
        No especificado
    {% endif %}
</div>
                            {% if request.user.is_authenticated %}
                            {% if request.user.is_authenticated %}
                            <br>
                            <div class="vacante-actions">
                                <form action="{% url 'eliminar_vacante' vacante.id %}" method="POST" class="d-inline" 
                                      onsubmit="return confirm('¿Estás seguro de que deseas eliminar esta vacante?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        🗑️
                                    </button>
                                </form>
                                <a href="{% url 'editar_vacante' vacante.id %}" class="btn btn-outline-info btn-sm">
                                    ✏️
                                </a>
                                <a href="{% url 'lista_candidatos' vacante.id %}" class="btn btn-outline-primary btn-sm">
                                    👥
                                </a>
                                <form action="{% url 'cambiar_estado_vacante' vacante.id %}" method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <label class="switch">
                                        <input type="checkbox" onchange="this.form.submit()" {% if vacante.estado %}checked{% endif %}>
                                        <span class="slider round">
                                            <span class="switch-text">{% if vacante.estado %}Activa{% else %}Inactiva{% endif %}</span>
                                        </span>
                                    </label>
                                </form>
                            </div>
                            {% endif %}
                            <div class="vacante-meta">
                                <small>🧑‍💼 Creado: {{ vacante.usuario_publicador.username|default:"No asignado" }} ({{ vacante.fecha_creacion|date:"d/m/Y" }})</small><br>
                                <small>🔁 Actualizado: {{ vacante.usuario_actualizador.username|default:"" }} ({{ vacante.fecha_actualizacion|date:"d/m/Y" }})</small><br>
                                <small>👥 Candidatos: {{ vacante.num_candidatos }}</small><br>
                                <small>ID Vacante: {{ vacante.codigo_vacante|default:"No asignado" }}</small>

                            </div>
                            {% endif %}
                        </div>
                    </div>
                    

                </div>

                <div class="badge-container">
                    <div class="info-badge">
                        👥 {{ vacante.numero_puestos }} vacantes
                    </div>
                    <div class="info-badge">
                        ⏳ {{ vacante.tiempo_experiencia }}
                    </div>
                    <div class="info-badge">
                        🎓 {{ vacante.nivel_estudios }}
                    </div>
                    <div class="info-badge">
                        🏢 {{ vacante.modalidad_trabajo }}
                    </div>
                    <div class="info-badge">
                            {% if vacante.rango_salarial %}
                            💰 $  {{ vacante.rango_salarial|intcomma }}
                            {% else %}
                                Salario a convenir
                            {% endif %}
                    </div>
                </div>
                <br>
                <!-- Botón de Descripción Vacante - Ocupa toda la parte inferior -->
                <div class="mt-auto">
                    <button class="btn btn-outline-warning w-100 toggle-info d-flex align-items-center justify-content-center" 
                            type="button"
                            data-bs-toggle="modal" 
                            data-bs-target="#modal-{{ vacante.id }}">
                        Descripción Vacante <i class="fas fa-chevron-down toggle-icon ms-2"></i>
                    </button>
                    <br>
                    <div class="checkbox-container">
                        <input class="selection-checkbox" type="checkbox" id="check{{ vacante.id }}" onchange="handleVacanteSelection('{{ vacante.id }}')">
                        
                        <label for="check{{ vacante.id }}"></label>
                    </div>
    
                </div>
            </div>

            <!-- Modal para detalles de vacante -->
            <div class="modal fade" id="modal-{{ vacante.id }}" tabindex="-1" role="dialog" aria-labelledby="modalLabel-{{ vacante.id }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalLabel-{{ vacante.id }}">Detalles de la Vacante: {{ vacante.cargo }}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-12 mb-4">
                                    <h6 class="text-warning mb-3">📝 Descripción de la Vacante</h6>
                                    <p class="descripcion-vacante">{{ vacante.descripcion_vacante }}</p>
                                </div>                                                                
                                <div class="col-md-6">
                                    <h6 class="text-warning mb-3">📊 Información General</h6>
                                    <ul class="list-group list-group-flush bg-transparent">
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>👥 Número de puestos:</strong> {{ vacante.numero_puestos }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>⏳ Experiencia requerida:</strong> {{ vacante.tiempo_experiencia }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>🎓 Nivel de estudios:</strong> {{ vacante.nivel_estudios }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>📍 Ubicación:</strong> 
    {% if vacante.ciudad %}
        {{ vacante.ciudad }}
    {% elif vacante.departamento %}
        {{ vacante.departamento }}
    {% else %}
        No especificado
    {% endif %}
</li>
                                    </ul>
                                </div>
                                
                                <div class="col-md-6">
                                    <h6 class="text-warning mb-3">💼 Condiciones Laborales</h6>
                                    <ul class="list-group list-group-flush bg-transparent">
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>🏢 Modalidad:</strong> {{ vacante.modalidad_trabajo }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>📄 Tipo de contrato:</strong> {{ vacante.tipo_contrato }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>⏰ Jornada:</strong> {{ vacante.jornada_trabajo }}
                                        </li>
                                        <li class="list-group-item bg-transparent border-secondary">
                                            <strong>💰 Salario: $</strong> {{ vacante.rango_salarial|intcomma }}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="modal-check{{ vacante.id }}" 
                                       value="{{ vacante.id }}" onchange="handleModalSelection('{{ vacante.id }}')" 
                                       {% if vacante.id in selected_vacantes %}checked{% endif %}>
                                <label class="form-check-label" for="modal-check{{ vacante.id }}">Seleccionar vacante</label>
                            </div>
                            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cerrar</button>
                            <br><br><br>
                        </div>
                        <hr>
                        <hr>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<a href="{% url 'registro_candidato' %}" class="btn btn-warning floating-button d-none" id="registroButton" onclick="redirectToRegistro(event)">
    ✨ Registrar mis datos
</a>

<!-- Offcanvas Filter -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title text-light">🔍 Filtrar Vacantes</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    
    <div class="offcanvas-body">
        <!-- Contenedor con desplazamiento para manejo de contenido largo -->
        <div class="filters-container" style="max-height: calc(100vh - 70px); overflow-y: auto;">
            <form action="" method="GET" id="filter-form">
                {% if request.user.is_authenticated %}
                <div class="mb-3">
                    <label for="codigo_vacante" class="form-label text-light">🔎 ID Vacante</label>
                    <input type="text" class="form-control" id="codigo_vacante" name="codigo_vacante" value="{{ request.GET.codigo_vacante }}">
                </div>
                {% endif %}
                <div class="mb-3">
                    <label for="cargo" class="form-label text-light">💼 Cargo</label>
                    <input type="text" class="form-control" id="cargo" name="cargo" value="{{ request.GET.cargo }}">
                </div>
                <div class="mb-3">
                    <label for="area" class="form-label text-light">🎯 Área</label>
                    <select class="form-control multiselect-improved" id="area" name="area" multiple="multiple">
                        {% for value, label in area_choices %}
                            <option value="{{ value }}" {% if value in filtros.area_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="modalidad_trabajo" class="form-label text-light">🏢 Modalidad de Trabajo</label>
                    <select class="form-control multiselect-improved" id="modalidad_trabajo" name="modalidad_trabajo" multiple="multiple">
                        {% for value, label in modalidad_trabajo_choices %}
                            <option value="{{ value }}" {% if value in filtros.modalidad_trabajo_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="tipo_contrato" class="form-label text-light">📄 Tipo de Contrato</label>
                    <select class="form-control multiselect-improved" id="tipo_contrato" name="tipo_contrato" multiple="multiple">
                        {% for value, label in tipo_contrato_choices %}
                            <option value="{{ value }}" {% if value in filtros.tipo_contrato_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="jornada_trabajo" class="form-label text-light">⏰ Jornada de Trabajo</label>
                    <select class="form-control multiselect-improved" id="jornada_trabajo" name="jornada_trabajo" multiple="multiple">
                        {% for value, label in jornada_trabajo_choices %}
                            <option value="{{ value }}" {% if value in filtros.jornada_trabajo_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="tiempo_experiencia" class="form-label text-light">⌛ Tiempo de Experiencia</label>
                    <select class="form-control multiselect-improved" id="tiempo_experiencia" name="tiempo_experiencia" multiple="multiple">
                        {% for value, label in tiempo_experiencia_choices %}
                            <option value="{{ value }}" {% if value in filtros.tiempo_experiencia_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="nivel_estudios" class="form-label text-light">🎓 Nivel de Estudios</label>
                    <select class="form-control multiselect-improved" id="nivel_estudios" name="nivel_estudios" multiple="multiple">
                        {% for value, label in nivel_estudios_choices %}
                            <option value="{{ value }}" {% if value in filtros.nivel_estudios_list %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="mb-3">
                    <label for="departamento" class="form-label text-light">🌍 Departamento</label>
                    <select class="form-control multiselect-improved" id="departamento" name="departamento" multiple="multiple">
                        {% for value, label in departamento_choices %}
                            <option value="{{ value }}" {% if value|stringformat:"s" in filtros.departamento_list %}selected{% endif %}>
                                {{ label }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="ciudad" class="form-label text-light">📍 Ciudad</label>
                    <select class="form-control multiselect-improved" id="ciudad" name="ciudad" multiple="multiple">
                        {% if filtros.ciudad_list %}
                            {% for ciudad_id, ciudad_nombre in filtros.ciudad_opciones %}
                                <option value="{{ ciudad_id }}" selected>{{ ciudad_nombre }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label text-light">💰 Rango Salarial</label>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control" placeholder="Desde" id="rango_salarial_min" name="rango_salarial_min" value="{{ filtros.rango_salarial_min }}">
                        <input type="text" class="form-control" placeholder="Hasta" id="rango_salarial_max" name="rango_salarial_max" value="{{ filtros.rango_salarial_max }}">
                    </div>
                </div>
                
                <div class="d-grid gap-2 mt-4 mb-3">
                    <button type="submit" class="btn btn-primary">
                        🔍 Aplicar Filtros
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearFilters()">
                        🧹 Borrar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script> // Filtros Vacantes
    $(document).ready(function() {
        $('.multiselect-improved').select2({
            theme: 'bootstrap-5',
            placeholder: 'Seleccionar',
            allowClear: true,
            width: '100%',
            dropdownParent: $('#offcanvasExample'),
            multiple: true,
            closeOnSelect: false,
            selectOnClose: false,
            language: {
                noResults: function () {
                    return "No se encontraron resultados";
                }
            },
        });
    });
    
    // Función para limpiar filtros
    function clearFilters() {
        // Limpia todos los select2
        $('.multiselect-improved').val(null).trigger('change');
        
        // Limpia inputs de texto
        $('#codigo_vacante, #cargo, #rango_salarial_min, #rango_salarial_max').val('');
    }
    </script>
    
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("active-filters-container").addEventListener("click", function (event) {
            if (event.target.classList.contains("remove-filter")) {
                let filterKey = event.target.getAttribute("data-filter-key");
                let filterValue = event.target.getAttribute("data-filter-value");
    
                // Eliminar el filtro correspondiente
                let filterElement = document.getElementById(filterKey);
                if (filterElement) {
                    if (filterElement.tagName === "SELECT") {
                        // Si es un select múltiple, eliminar solo el valor específico
                        let selectedValues = Array.from(filterElement.selectedOptions)
                            .map(option => option.value)
                            .filter(value => value !== filterValue);
    
                        // Actualizar valores del select
                        $(filterElement).val(selectedValues).trigger('change');
                    } else {
                        // Si es un input de texto, simplemente vaciarlo
                        filterElement.value = "";
                    }
                }
    
                // Enviar el formulario automáticamente para actualizar los resultados
                document.getElementById("filter-form").submit();
            }
        });
    });
    
    $(document).ready(function() {
        // Inicializar todos los multiselect con configuración mejorada
        $('.multiselect-improved').each(function() {
            var selectId = $(this).attr('id');
            
            $(this).multiselect({
                buttonClass: 'btn btn-outline-secondary',
                enableFiltering: true,
                enableCaseInsensitiveFiltering: true,
                buttonWidth: '100%',
                maxHeight: 200,
                buttonText: function(options, select) {
                    if (options.length === 0) {
                        return 'Ninguno seleccionado';
                    }
                    else if (options.length <= 2) {
                        var labels = [];
                        options.each(function() {
                            if ($(this).attr('label') !== undefined) {
                                labels.push($(this).attr('label'));
                            } else {
                                labels.push($(this).text());
                            }
                        });
                        return labels.join(', ');
                    }
                    else {
                        return options.length + ' seleccionados';
                    }
                },
                onDropdownShown: function() {
                    // Asegurar que el dropdown no se salga del offcanvas
                    var $dropdown = $(this.$ul[0]);
                    var dropdownHeight = $dropdown.height();
                    var viewportHeight = $('.offcanvas-body').height();
                    var dropdownTop = $dropdown.offset().top - $('.offcanvas-body').offset().top;
                    
                    if (dropdownTop + dropdownHeight > viewportHeight) {
                        $dropdown.css('top', 'auto');
                        $dropdown.css('bottom', '100%');
                    }
                },
                onChange: function(option, checked) {
                    // Crear o actualizar el contenedor de etiquetas
                    var selectId = $(option).parent().attr('id');
                    var optionContainer = $('#' + selectId + '-options');
                    
                    if (optionContainer.length === 0) {
                        $('#' + selectId).after('<div id="' + selectId + '-options" class="selected-options"></div>');
                        optionContainer = $('#' + selectId + '-options');
                    }
                    
                    // Actualizar las etiquetas visuales
                    updateOptionTags(selectId);
                }
            });
            
            // Crear contenedor para mostrar opciones seleccionadas como etiquetas
            var optionsContainer = $('<div id="' + selectId + '-options" class="selected-options"></div>');
            $('#' + selectId).after(optionsContainer);
            
            // Inicializar etiquetas para opciones ya seleccionadas
            updateOptionTags(selectId);
        });
        
        // Función para actualizar las etiquetas visuales de las opciones seleccionadas
        function updateOptionTags(selectId) {
            var select = $('#' + selectId);
            var container = $('#' + selectId + '-options');
            container.empty();
            
            select.find('option:selected').each(function() {
                var value = $(this).val();
                var text = $(this).text();
                
                var tag = $('<span class="option-tag">' + text + 
                            '<span class="remove-option" data-value="' + value + '">×</span></span>');
                
                container.append(tag);
            });
            
            // Manejar clics en el botón de eliminar
            container.find('.remove-option').on('click', function() {
                var value = $(this).data('value');
                
                // Deseleccionar la opción en el select
                select.multiselect('deselect', value);
                
                // Eliminar la etiqueta
                $(this).parent().remove();
            });
        }
        
        // Función para limpiar los filtros
        window.clearFilters = function() {
            $('#filter-form input[type="text"]').val('');
            $('.multiselect-improved').multiselect('deselectAll', false);
            $('.multiselect-improved').each(function() {
                var selectId = $(this).attr('id');
                $('#' + selectId + '-options').empty();
            });
            $('#filter-form').submit();
        };
    });
    
// Agregar este código después de cargar jQuery y Bootstrap-Multiselect

$(document).ready(function() {
    // Inicializar multiselect con configuración personalizada
    $('.multiselect').multiselect({
        buttonWidth: '100%',
        enableHTML: true,
        buttonClass: 'form-control text-start',
        templates: {
            button: '<button type="button" class="multiselect dropdown-toggle" data-bs-toggle="dropdown"><span class="multiselect-selected-text"></span></button>',
            ul: '<ul class="multiselect-container dropdown-menu p-1 w-100"></ul>',
            li: '<li><a tabindex="0" class="dropdown-item"><label></label></a></li>',
            // Personalizar el contenedor de los elementos seleccionados
            buttonContainer: '<div class="btn-group w-100 multiselect-selected-container"></div>'
        },
        buttonText: function(options, select) {
            if (options.length === 0) {
                return 'Seleccionar...';
            }
            else {
                var labels = [];
                options.each(function() {
                    if ($(this).attr('label') !== undefined) {
                        labels.push($(this).attr('label'));
                    }
                    else {
                        labels.push($(this).html());
                    }
                });
                
                // Limitar a mostrar solo 2 elementos y añadir contador
                if (labels.length > 2) {
                    return labels.slice(0, 2).join(', ') + ' <span class="badge bg-primary">' + '+' + (labels.length - 2) + '</span>';
                }
                return labels.join(', ');
            }
        },
        onDropdownShown: function(event) {
            // Ajustar altura del dropdown si hay muchos elementos
            var dropdownMenu = $(event.target).siblings('.multiselect-container');
            if (dropdownMenu.find('li').length > 10) {
                dropdownMenu.css({
                    'max-height': '300px',
                    'overflow-y': 'auto'
                });
            }
        }
    });

    // CSS personalizado para la visualización de los elementos seleccionados
    $('<style>')
        .prop('type', 'text/css')
        .html(`
            .multiselect-selected-container {
                display: block;
                width: 100%;
            }
            .multiselect-selected-text {
                white-space: normal;
                text-overflow: ellipsis;
                overflow: hidden;
                display: block;
                text-align: left;
                max-height: 60px;
                overflow-y: auto;
            }
            .multiselect-container label {
                display: block;
                width: 100%;
                padding: 3px;
                margin: 0;
            }
            .badge.bg-primary {
                margin-left: 5px;
            }
        `)
        .appendTo('head');
});

// Inicialización de los multiselect con Select2
$(document).ready(function() {
    // Inicializar todos los multiselect
    $('.multiselect').select2({
        theme: 'bootstrap4',
        width: '100%',
        allowClear: true,
        closeOnSelect: false,
        multiple: true
    });

    // Gestionar relación dinámica entre departamentos y ciudades
    $('#departamento').on('change', function() {
        const departamentos = $(this).val() || [];
        
        if (departamentos.length > 0) {
            // Llamada AJAX para obtener ciudades de los departamentos seleccionados
            $.ajax({
                url: '/api/ciudades-por-departamentos/',
                data: { 'departamentos': departamentos.join(',') },
                dataType: 'json',
                success: function(data) {
                    const ciudadSelect = $('#ciudad');
                    const selectedCiudades = ciudadSelect.val() || [];
                    
                    // Mantener las ciudades ya seleccionadas que pertenezcan a los departamentos
                    ciudadSelect.empty();
                    
                    data.forEach(function(ciudad) {
                        const option = new Option(ciudad.nombre, ciudad.id, false, selectedCiudades.includes(ciudad.id.toString()));
                        ciudadSelect.append(option);
                    });
                    
                    ciudadSelect.trigger('change');
                }
            });
        }
    });

    // Actualizar filtros activos cuando cambie cualquier filtro
    updateActiveFilters();
    
    // Eventos para actualizar la visualización de filtros activos
    $('.multiselect, #cargo, #codigo_vacante, #rango_salarial_min, #rango_salarial_max').on('change', function() {
        updateActiveFilters();
    });
});

// Función para actualizar la sección de filtros activos
function updateActiveFilters() {
    const filterContainer = $('#active-filters-container');
    filterContainer.empty();
    
    let hasActiveFilters = false;
    
    // Verificar y mostrar cada tipo de filtro
    const filterTypes = [
        { id: 'codigo_vacante', label: 'ID Vacante', type: 'text', icon: '🔎' },
        { id: 'cargo', label: 'Cargo', type: 'text', icon: '💼' },
        { id: 'area', label: 'Área', type: 'select', icon: '🎯' },
        { id: 'modalidad_trabajo', label: 'Modalidad', type: 'select', icon: '🏢' },
        { id: 'tipo_contrato', label: 'Contrato', type: 'select', icon: '📄' },
        { id: 'jornada_trabajo', label: 'Jornada', type: 'select', icon: '⏰' },
        { id: 'tiempo_experiencia', label: 'Experiencia', type: 'select', icon: '⌛' },
        { id: 'nivel_estudios', label: 'Estudios', type: 'select', icon: '🎓' },
        { id: 'departamento', label: 'Departamento', type: 'select', icon: '🌍' },
        { id: 'ciudad', label: 'Ciudad', type: 'select', icon: '📍' }
    ];
    
    // Añadir filtros de rango salarial
    const minSalario = $('#rango_salarial_min').val();
    const maxSalario = $('#rango_salarial_max').val();
    
    if (minSalario || maxSalario) {
        hasActiveFilters = true;
        let salarioText = '💰 Salario: ';
        
        if (minSalario && maxSalario) {
            salarioText += `$${minSalario} - $${maxSalario}`;
        } else if (minSalario) {
            salarioText += `Desde $${minSalario}`;
        } else {
            salarioText += `Hasta $${maxSalario}`;
        }
        
        addFilterBadge(filterContainer, 'salario', salarioText);
    }
    
    // Procesar cada tipo de filtro
    filterTypes.forEach(filter => {
        const element = $(`#${filter.id}`);
        
        if (filter.type === 'text' && element.val()) {
            hasActiveFilters = true;
            addFilterBadge(filterContainer, filter.id, `${filter.icon} ${filter.label}: ${element.val()}`);
        } 
        else if (filter.type === 'select') {
            const selectedValues = element.val();
            if (selectedValues && selectedValues.length > 0) {
                hasActiveFilters = true;
                
                // Para selects múltiples, mostrar cada selección individual
                selectedValues.forEach(function(value) {
                    const optionText = element.find(`option[value="${value}"]`).text();
                    addFilterBadge(filterContainer, `${filter.id}-${value}`, `${filter.icon} ${filter.label}: ${optionText}`);
                });
            }
        }
    });
    
    // Mostrar mensaje si no hay filtros activos
    if (!hasActiveFilters) {
        filterContainer.html('<span class="text-light">No hay filtros aplicados</span>');
    }
}

// Función para añadir una insignia de filtro
function addFilterBadge(container, id, text) {
    const badge = $(`<span class="badge filter-badge" data-filter-id="${id}">${text} <i class="fas fa-times remove-filter"></i></span>`);
    
    // Agregar evento para eliminar filtro individual
    badge.find('.remove-filter').on('click', function() {
        removeFilter(id);
    });
    
    container.append(badge);
}

// Función para eliminar filtro individual
function removeFilter(filterId) {
    // Diferentes acciones dependiendo del tipo de filtro
    if (filterId === 'salario') {
        $('#rango_salarial_min, #rango_salarial_max').val('');
    } else if (filterId === 'cargo' || filterId === 'codigo_vacante') {
        $(`#${filterId}`).val('');
    } else {
        // Para filtros multiselect, extraer el ID del campo y el valor
        const parts = filterId.split('-');
        if (parts.length === 2) {
            const fieldId = parts[0];
            const valueToRemove = parts[1];
            
            // Obtener valores actuales, quitar el valor específico
            const select = $(`#${fieldId}`);
            const currentValues = select.val() || [];
            const newValues = currentValues.filter(v => v !== valueToRemove);
            
            select.val(newValues).trigger('change');
        }
    }
    
    // Actualizar visualización de filtros
    updateActiveFilters();
}

// Función para limpiar todos los filtros
function clearFilters() {
    // Limpiar los campos de texto
    $('#cargo, #codigo_vacante, #rango_salarial_min, #rango_salarial_max').val('');
    
    // Limpiar los select múltiples
    $('.multiselect').val(null).trigger('change');
    
    // Actualizar los filtros activos
    updateActiveFilters();
}
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.querySelector('.offcanvas-body form');
        
        form.addEventListener('submit', function(event) {
            // Obtener los inputs
            const minInput = document.getElementById('rango_salarial_min');
            const maxInput = document.getElementById('rango_salarial_max');
    
            // Remover puntos antes de enviar
            if (minInput.value) {
                minInput.value = minInput.value.replace(/\./g, '');
            }
            if (maxInput.value) {
                maxInput.value = maxInput.value.replace(/\./g, '');
            }
        });
    }); 
    
let selectedVacantes = [];

function handleVacanteSelection(vacanteId) {
    const checkbox = document.getElementById('check' + vacanteId);
    const modalCheckbox = document.getElementById('modal-check' + vacanteId);
    const vacanteCard = checkbox.closest('.vacante-card');

    if (checkbox.checked) {
        vacanteCard.classList.add('selected'); // Aplicar sombra verde al instante
        if (!selectedVacantes.includes(vacanteId)) {
            selectedVacantes.push(vacanteId);
        }
        if (modalCheckbox) modalCheckbox.checked = true;
    } else {
        vacanteCard.classList.remove('selected'); // Quitar sombra al instante
        selectedVacantes = selectedVacantes.filter(id => id !== vacanteId);
        if (modalCheckbox) modalCheckbox.checked = false;
    }

    updateFloatingButton();
    localStorage.setItem('selectedVacantes', JSON.stringify(selectedVacantes));
}

document.addEventListener('DOMContentLoaded', function() {
    // Función para formatear con puntos de miles
    const formatNumber = (input) => {
        // Eliminar puntos existentes
        let value = input.value.replace(/\./g, '');

        // Asegurarse de que solo hay números
        if (!isNaN(value) && value !== '') {
            // Convertir a número y formatear con puntos de miles
            value = parseInt(value).toLocaleString('es-CO');
            input.value = value;
        } else {
            // Si no es número, limpiar el campo
            input.value = '';
        }
    };

    // Obtener los inputs
    const minInput = document.getElementById('rango_salarial_min');
    const maxInput = document.getElementById('rango_salarial_max');

    // Aplicar la función mientras el usuario escribe
    minInput.addEventListener('input', () => formatNumber(minInput));
    maxInput.addEventListener('input', () => formatNumber(maxInput));
});


function handleModalSelection(vacanteId) {
    const modalCheckbox = document.getElementById('modal-check' + vacanteId);
    const checkbox = document.getElementById('check' + vacanteId);
    const vacanteCard = checkbox.closest('.vacante-card');

    if (modalCheckbox.checked) {
        vacanteCard.classList.add('selected'); // Aplicar sombra verde al instante
        if (!selectedVacantes.includes(vacanteId)) {
            selectedVacantes.push(vacanteId);
        }
        checkbox.checked = true;
    } else {
        vacanteCard.classList.remove('selected'); // Quitar sombra al instante
        selectedVacantes = selectedVacantes.filter(id => id !== vacanteId);
        checkbox.checked = false;
    }

    updateFloatingButton();
    localStorage.setItem('selectedVacantes', JSON.stringify(selectedVacantes));
}

document.addEventListener('DOMContentLoaded', function() {
    const stored = localStorage.getItem('selectedVacantes');
    if (stored) {
        selectedVacantes = JSON.parse(stored);
        selectedVacantes.forEach(id => {
            const checkbox = document.getElementById('check' + id);
            const modalCheckbox = document.getElementById('modal-check' + id);
            const vacanteCard = checkbox?.closest('.vacante-card');

            if (checkbox && vacanteCard) {
                checkbox.checked = true;
                vacanteCard.classList.add('selected'); // Aplicar sombra en la carga
            }
            if (modalCheckbox) {
                modalCheckbox.checked = true;
            }
        });
    }
    updateFloatingButton();
});


function updateFloatingButton() {
    const button = document.getElementById('registroButton');
    
    if (selectedVacantes.length === 0) {
        button.innerHTML = '✨ Registrar mis datos';
        button.classList.remove('d-none');
        button.classList.remove('btn-success');
        button.classList.add('btn-warning');
    } else {
        button.innerHTML = `🎯 Aplicar a ${selectedVacantes.length} vacante${selectedVacantes.length > 1 ? 's' : ''}`;
        button.classList.remove('d-none');
        button.classList.remove('btn-warning');
        button.classList.add('btn-success');
    }
    
    localStorage.setItem('selectedVacantes', JSON.stringify(selectedVacantes));
}

function clearFilters() {
    const formElements = document.querySelectorAll('.offcanvas-body form input, .offcanvas-body form select');
    formElements.forEach(input => {
        if (input.type === 'text' || input.tagName === 'SELECT') {
            input.value = '';
        }
    });
    window.location.href = window.location.pathname;
}

function redirectToRegistro(event) {
    event.preventDefault();
    const url = "{% url 'registro_candidato' %}?selected_vacantes=" + selectedVacantes.join(',');
    window.location.href = url;
}

document.addEventListener('DOMContentLoaded', function() {
    // Inicializar modales de Bootstrap
    const modales = document.querySelectorAll('.modal');
    modales.forEach(modal => {
        new bootstrap.Modal(modal, {
            backdrop: true,
            keyboard: true,
            focus: true
        });
    });

    // Cargar selecciones guardadas
    const stored = localStorage.getItem('selectedVacantes');
    if (stored) {
        selectedVacantes = JSON.parse(stored);
        selectedVacantes.forEach(id => {
            const checkbox = document.getElementById('check' + id);
            const modalCheckbox = document.getElementById('modal-check' + id);
            if (checkbox) checkbox.checked = true;
            if (modalCheckbox) modalCheckbox.checked = true;
        });
        updateFloatingButton();
    } else {
        document.getElementById('registroButton').classList.remove('d-none');
    }

    // Manejar los departamentos y ciudades
    const departamentoSelect = document.getElementById("departamento");
    const ciudadSelect = document.getElementById("ciudad");

    if (departamentoSelect) {
        departamentoSelect.addEventListener("change", function() {
            const departamentoId = this.value;
            ciudadSelect.innerHTML = '<option value="">-- Selecciona una ciudad --</option>';

            if (departamentoId) {
                fetch(`/cargar-ciudades/?departamento_id=${departamentoId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(ciudad => {
                            const option = document.createElement("option");
                            option.value = ciudad.id;
                            option.textContent = ciudad.nombre;
                            ciudadSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error("Error cargando ciudades:", error));
            }
        });

        // Cargar ciudades si hay un departamento seleccionado al cargar la página
        if (departamentoSelect.value) {
            cargarCiudades(departamentoSelect.value, '{{ filtros.ciudad }}');
        }
    }
});

function cargarCiudades(departamentoId, ciudadSeleccionada) {
    const ciudadSelect = document.getElementById("ciudad");
    
    if (departamentoId && ciudadSelect) {
        fetch(`/cargar-ciudades/?departamento_id=${departamentoId}`)
            .then(response => response.json())
            .then(data => {
                ciudadSelect.innerHTML = '<option value="">-- Selecciona una ciudad --</option>';
                data.forEach(ciudad => {
                    const option = document.createElement("option");
                    option.value = ciudad.id;
                    option.textContent = ciudad.nombre;
                    if (ciudad.id == ciudadSeleccionada) {
                        option.selected = true;
                    }
                    ciudadSelect.appendChild(option);
                });
            })
            .catch(error => console.error("Error cargando ciudades:", error));
    }
    }
    function desmarcarVacantes() {
        // Limpiar el array de vacantes seleccionadas
        selectedVacantes = [];
        
        // Desmarcar todos los checkboxes principales
        const checkboxes = document.querySelectorAll('.selection-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Desmarcar todos los checkboxes en los modales
        const modalCheckboxes = document.querySelectorAll('[id^="modal-check"]');
        modalCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        // Limpiar el localStorage
        localStorage.removeItem('selectedVacantes');
        
        // Actualizar el botón flotante
        updateFloatingButton();
    }
    function showTutorial() {
    const noShow = localStorage.getItem('noShowTutorial');
    if (!noShow) {
        document.getElementById('tutorialModal').style.display = 'block';
    }
}

function closeTutorial() {
    document.getElementById('tutorialModal').style.display = 'none';
    if (document.getElementById('noShowAgain').checked) {
        localStorage.setItem('noShowTutorial', 'true');
    }
}

// Añade esto al final del DOMContentLoaded existente
document.addEventListener('DOMContentLoaded', function() {
    // ... código existente ...
    
    // Mostrar el tutorial
    showTutorial();
});

</script>
{% endblock %}