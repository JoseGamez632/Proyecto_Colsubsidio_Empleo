{% extends 'base.html' %}
{% load static %}

{% block titulo %}
Inicio
{% endblock %}

{% block contenido %}
<style>
    .gradient-bg {
        background: linear-gradient(135deg, rgba(33, 37, 41, 0.97), rgba(33, 37, 41, 0.95));
        backdrop-filter: blur(10px);
        min-height: 100vh;
    }
    
    .card {
        background: rgba(33, 37, 41, 0.8);
        backdrop-filter: blur(5px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .floating-button {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        transition: all 0.3s ease;
        min-width: 200px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .floating-button:hover {
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }
    
    .offcanvas {
        background: rgba(33, 37, 41, 0.98);
        backdrop-filter: blur(10px);
    }
    
    .form-control {
        background: rgba(52, 58, 64, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #fff;
    }
    
    .form-control:focus {
        background: rgba(52, 58, 64, 0.9);
        border-color: rgba(255, 255, 255, 0.2);
        color: #fff;
        box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.1);
    }

    .info-badge {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.5rem 1rem;
        border-radius: 50px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0.25rem;
        transition: all 0.3s ease;
    }

    .info-badge:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
    }

    .emoji-icon {
        font-size: 1.2rem;
        margin-right: 0.5rem;
    }


    .switch {
        position: relative;
        display: inline-block;
        width: 86px;
        height: 30px;
    }
    
    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    
    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: red;
        transition: .4s;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px
    }
    
    .slider:before {
        position: absolute;
        content: "";
        height: 12px;
        width: 12px;
        left: 4px;
        bottom: 9px;
        background-color: white;
        transition: .4s;
    }
    
    input:checked + .slider {
        background-color: green;
    }
    
    input:checked + .slider:before {
        transform: translateX(66px);
    }
    
    .slider.round {
        border-radius: 34px;
    }
    
    .slider.round:before {
        border-radius: 50%;
    }

    .switch-text {
        position: absolute;
        width: 100%;
        text-align: center;
        pointer-events: none;
      }

</style>

<div class="gradient-bg">
    <div class="container py-5">
        <!-- Header Section -->
        <div class="mb-5">
            <h1 class="text-warning mb-4 fw-bold">Listado de Vacantes Activas</h1>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-outline-light" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample">
                    üîç Filtrar Vacantes
                </button>
                <button type="button" class="btn btn-outline-light" onclick="clearFilters()">
                    üßπ Borrar Filtros
                </button>
                {% if request.user.is_authenticated %}
                <a class="btn btn-outline-warning" href="{% url 'agregar_vacante' %}">
                    ‚ûï Agregar Vacante
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Job Listings -->
        <div class="row g-4">
            {% for vacante in vacantes %}
            <div class="col-12">
                <div class="card text-light">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="d-flex align-items-center gap-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="{{ vacante.id }}" 
                                           id="check{{ vacante.id }}" onchange="handleVacanteSelection('{{ vacante.id }}')">
                                </div>
                                <div>
                                    <h3 class="card-title h5 mb-1">
                                        üíº {{ vacante.cargo }}
                                    </h3>
                                    <span class="badge bg-warning text-dark">
                                        üìç {{ vacante.ciudad }}
                                    </span>
                                    <br>
                                    {% if request.user.is_authenticated %}

                                    <span class="badge bg-warning text-dark">
                                        üßë‚Äçüíº Creado: {{ vacante.usuario_publicador.username|default:"No asignado" }} {{ vacante.fecha_creacion|date:"d/m/Y" }}
                                    </span>
                                    <span class="badge bg-warning text-dark">
                                        üîÅ Actualizado: {{ vacante.usuario_actualizador.username|default:"" }} {{ vacante.fecha_actualizacion|date:"d/m/Y" }}
                                    </span>
                                        <p style="margin-top: 10px;">Candidatos: {{ vacante.num_candidatos }}</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% if request.user.is_authenticated %}
                            <div class="d-flex gap-2">
                                <form action="{% url 'eliminar_vacante' vacante.id %}" method="POST" class="d-inline" 
                                      onsubmit="return confirm('¬øEst√°s seguro de que deseas eliminar esta vacante?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        üóëÔ∏è
                                    </button>
                                </form>
                                <a href="{% url 'editar_vacante' vacante.id %}" class="btn btn-outline-info btn-sm">
                                    ‚úèÔ∏è
                                </a>
                                <a href="{% url 'lista_candidatos' vacante.id %}" class="btn btn-outline-primary btn-sm">
                                    üë•
                                </a>
                                <form action="{% url 'cambiar_estado_vacante' vacante.id %}" method="POST" style="display: inline;">
                                    {% csrf_token %}
                                    <label class="switch">
                                        <input type="checkbox" onchange="this.form.submit()" {% if vacante.estado %}checked{% endif %}>
                                        <span class="slider round">
                                            <span class="switch-text">{% if vacante.estado %}Activa{% else %}Inactiva{% endif %}</span>
                                        </span>
                                    </label>
                                </form>
                            </div>
                            {% endif %}
                        </div>

                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <div class="info-badge">
                                üë• {{ vacante.numero_puestos }} vacantes
                            </div>
                            <div class="info-badge">
                                ‚è≥ {{ vacante.tiempo_experiencia }}
                            </div>
                            <div class="info-badge">
                                üéì {{ vacante.nivel_estudios }}
                            </div>
                            <div class="info-badge">
                                üè¢ {{ vacante.modalidad_trabajo }}
                            </div>
                            <div class="info-badge">
                                üí∞ {{ vacante.rango_salarial }}
                            </div>
                        </div>

                        <div class="collapse" id="collapse-{{ vacante.id }}">
                            <div class="card card-body bg-dark bg-opacity-50 text-light border-0">
                                üìù {{ vacante.descripcion_vacante }}
                            </div>
                        </div>

                        <button class="btn btn-link text-warning text-decoration-none p-0" 
                                type="button"
                                data-bs-toggle="collapse" 
                                data-bs-target="#collapse-{{ vacante.id }}"
                                aria-expanded="false">
                            üìÑ Ver m√°s detalles
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<a href="{% url 'registro_candidato' %}" class="btn btn-warning floating-button d-none" id="registroButton" onclick="redirectToRegistro(event)">
    ‚ú® Registrar mis datos
</a>

<!-- Offcanvas Filter -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasExample">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title text-light">üîç Filtrar Vacantes</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <form action="" method="GET">
            <div class="mb-3">
                <label for="cargo" class="form-label text-light">üíº Cargo</label>
                <input type="text" class="form-control" id="cargo" name="cargo" value="{{ request.GET.cargo }}">
            </div>

            <div class="mb-3">
                <label for="area" class="form-label text-light">üéØ √Årea</label>
                <select class="form-control" id="area" name="area">
                    <option value=""></option>
                    {% for value, label in area_choices %}
                        <option value="{{ value }}" {% if filtros.area == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="modalidad_trabajo" class="form-label text-light">üè¢ Modalidad de Trabajo</label>
                <select class="form-control" id="modalidad_trabajo" name="modalidad_trabajo">
                    <option value=""></option>
                    {% for value, label in modalidad_trabajo_choices %}
                        <option value="{{ value }}" {% if filtros.modalidad_trabajo == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="tipo_contrato" class="form-label text-light">üìÑ Tipo de Contrato</label>
                <select class="form-control" id="tipo_contrato" name="tipo_contrato">
                    <option value=""></option>
                    {% for value, label in tipo_contrato_choices %}
                        <option value="{{ value }}" {% if filtros.tipo_contrato == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="jornada_trabajo" class="form-label text-light">‚è∞ Jornada de Trabajo</label>
                <select class="form-control" id="jornada_trabajo" name="jornada_trabajo">
                    <option value=""></option>
                    {% for value, label in jornada_trabajo_choices %}
                        <option value="{{ value }}" {% if filtros.jornada_trabajo == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="tiempo_experiencia" class="form-label text-light">‚åõ Tiempo de Experiencia</label>
                <select class="form-control" id="tiempo_experiencia" name="tiempo_experiencia">
                    <option value=""></option>
                    {% for value, label in tiempo_experiencia_choices %}
                        <option value="{{ value }}" {% if filtros.tiempo_experiencia == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="nivel_estudios" class="form-label text-light">üéì Nivel de Estudios</label>
                <select class="form-control" id="nivel_estudios" name="nivel_estudios">
                    <option value=""></option>
                    {% for value, label in nivel_estudios_choices %}
                        <option value="{{ value }}" {% if filtros.nivel_estudios == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="departamento" class="form-label text-light">üåç Departamento</label>
                <select class="form-control" id="departamento" name="departamento">
                    <option value=""></option>
                    {% for value, label in departamento_choices %}
                        <option value="{{ value }}" {% if filtros.departamento == value|stringformat:"s" %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label for="ciudad" class="form-label text-light">üìç Ciudad</label>
                <select class="form-control" id="ciudad" name="ciudad">
                    <option value=""></option>
                    {% if filtros.ciudad_nombre %}
                        <option value="{{ filtros.ciudad }}" selected>{{ filtros.ciudad_nombre }}</option>
                    {% endif %}
                </select>
            </div>

            <div class="mb-3">
                <label for="rango_salarial" class="form-label text-light">üí∞ Rango Salarial</label>
                <input type="text" class="form-control" id="rango_salarial" name="rango_salarial" value="{{ request.GET.rango_salarial }}">
            </div>

            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary">
                    üîç Aplicar Filtros
                </button>
                <button type="button" class="btn btn-danger" onclick="clearFilters()">
                    üßπ Borrar Filtros
                </button>
            </div>
        </form>
    </div>
</div>


<script>
let selectedVacantes = [];

function handleVacanteSelection(vacanteId) {
    const checkbox = document.getElementById('check' + vacanteId);
    const button = document.getElementById('registroButton');
    
    if (checkbox.checked) {
        if (!selectedVacantes.includes(vacanteId)) {
            selectedVacantes.push(vacanteId);
        }
    } else {
        selectedVacantes = selectedVacantes.filter(id => id !== vacanteId);
    }
    
    updateFloatingButton();
}

function updateFloatingButton() {
    const button = document.getElementById('registroButton');
    
    if (selectedVacantes.length === 0) {
        button.innerHTML = '‚ú® Registrar mis datos';
        button.classList.remove('d-none');
        button.classList.remove('btn-success');
        button.classList.add('btn-warning');
    } else {
        button.innerHTML = `üéØ Aplicar a ${selectedVacantes.length} vacante${selectedVacantes.length > 1 ? 's' : ''}`;
        button.classList.remove('d-none');
        button.classList.remove('btn-warning');
        button.classList.add('btn-success');
    }
    
    localStorage.setItem('selectedVacantes', JSON.stringify(selectedVacantes));
}

function clearFilters() {
    const formElements = document.querySelectorAll('.offcanvas-body form input');
    formElements.forEach(input => input.value = '');
}

function redirectToRegistro(event) {
    event.preventDefault();
    const url = "{% url 'registro_candidato' %}?selected_vacantes=" + selectedVacantes.join(',');
    window.location.href = url;
}

document.addEventListener('DOMContentLoaded', function() {
    const stored = localStorage.getItem('selectedVacantes');
    if (stored) {
        selectedVacantes = JSON.parse(stored);
        selectedVacantes.forEach(id => {
            const checkbox = document.getElementById('check' + id);
            if (checkbox) checkbox.checked = true;
        });
        updateFloatingButton();
    } else {
        document.getElementById('registroButton').classList.remove('d-none');
    }
});
</script>

<script>
    //para mostrar las ciudades de acuerdo al departamento seleccionado
    document.addEventListener("DOMContentLoaded", function () {
        const departamentoSelect = document.getElementById("departamento");
        const ciudadSelect = document.getElementById("ciudad");
    
        departamentoSelect.addEventListener("change", function () {
            const departamentoId = this.value;
            ciudadSelect.innerHTML = '<option value="">-- Selecciona una ciudad --</option>';
    
            if (departamentoId) {
                fetch(`/cargar-ciudades/?departamento_id=${departamentoId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(ciudad => {
                            const option = document.createElement("option");
                            option.value = ciudad.id;
                            option.textContent = ciudad.nombre;
                            ciudadSelect.appendChild(option);
                        });
                    })
                    .catch(error => console.error("Error cargando ciudades:", error));
            }
        });
    });
    // Cargar ciudades si hay un departamento seleccionado al recargar la p√°gina
    if (departamentoSelect.value) {
        cargarCiudades(departamentoSelect.value, ciudadSeleccionada);
    }


    </script>

    <script>
        function clearFilters() {
            // Redirigir a la misma p√°gina pero sin par√°metros en la URL, para borrar los filtros
            window.location.href = window.location.pathname;
        }
        </script>
        


{% endblock %}