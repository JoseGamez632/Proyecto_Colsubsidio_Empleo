{% extends 'base.html' %}

{% load static %}

{% block titulo %}
Candidatos para la Vacante
{% endblock %}

{% block contenido %}
<div class="container-fluid" style="opacity: 90%; background-color: #525252; color: #f1f1f1;">
    <div class="row">
        <div class="col py-3">
            <h1 style="color: #f8d047;">Candidatos para la Vacante: {{ vacante.cargo }}</h1>
            
            <!-- Filtros -->
            <div class="mb-4 p-3" style="background-color: #333333; border-radius: 8px;">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <input type="text" id="searchNombre" class="form-control" placeholder="Buscar por nombre...">
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="text" id="searchCiudad" class="form-control" placeholder="Buscar por ciudad...">
                    </div>
                    <div class="col-md-3 mb-2">
                        <input type="text" id="searchDocumento" class="form-control" placeholder="Buscar por documento...">
                    </div>
                    <div class="col-md-3 mb-2">
                        <button id="clearFilters" class="btn btn-warning w-100">Limpiar filtros</button>
                    </div>
                </div>
            </div>

            <!-- Botones de selección y descarga -->
            <div class="mb-4 p-3" style="background-color: #333333; border-radius: 8px;">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button id="selectAll" class="btn btn-primary w-100">Seleccionar Todo</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button id="deselectAll" class="btn btn-secondary w-100">Deseleccionar Todo</button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <form id="downloadForm" action="{% url 'descargar_candidatos' %}" method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="selected_candidates" id="selectedCandidates">
                            <button type="submit" id="downloadExcel" class="btn btn-success w-100" disabled>
                                Descargar Seleccionados
                            </button>
                        </form>
                    </div>
                    <div class="col-md-3 mb-2">
                        <span id="selectedCount" class="btn btn-info w-100">
                            Seleccionados: 0
                        </span>
                    </div>
                </div>
            </div>

            <!-- Lista de candidatos en tarjetas -->
            <div class="row" id="candidatosList">
                {% for candidato in candidatos %}
                <div class="col-md-6 col-lg-4 mb-3 candidato-card" 
                     data-nombre="{{ candidato.nombres }} {{ candidato.apellidos }}"
                     data-ciudad="{{ candidato.localidad_municipio }}"
                     data-documento="{{ candidato.numero_documento }}">
                    <div class="card h-100" style="background-color: #333333; color: #ffffff;">
                        <div class="card-body">
                            <div class="form-check mb-2">
                                <input class="form-check-input candidate-checkbox" 
                                       type="checkbox" 
                                       value="{{ candidato.id }}" 
                                       id="check_{{ candidato.id }}">
                                <label class="form-check-label" for="check_{{ candidato.id }}">
                                    Seleccionar
                                </label>
                            </div>
                            <h5 class="card-title text-warning mb-3">
                                {{ candidato.nombres }} {{ candidato.apellidos }}
                            </h5>
                            <!-- Resto del contenido de la tarjeta igual que antes -->
                            <div class="card-text">
                                <div class="mb-2 text-light">
                                    <i class="fas fa-map-marker-alt text-warning"></i>
                                    <span class="ms-2">{{ candidato.localidad_municipio }}</span>
                                </div>
                                <div class="mb-2 text-light">
                                    <i class="fas fa-id-card text-warning"></i>
                                    <span class="ms-2">{{ candidato.tipo_documento }}: {{ candidato.numero_documento }}</span>
                                </div>
                                <div class="mb-3 text-light">
                                    <i class="fas fa-calendar text-warning"></i>
                                    <span class="ms-2">Feria: {{ candidato.fecha_feria }}</span>
                                </div>
                            </div>
                            <button class="btn btn-primary btn-sm w-100 view-details" data-candidato-id="{{ candidato.id }}">
                                <i class="fas fa-eye me-1"></i> Ver Hoja de Vida
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="col">
                    <div class="alert alert-warning">No hay candidatos para esta vacante.</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Modal para la hoja de vida -->
<div class="modal fade" id="cvModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: #333333; color: #ffffff;">
            <div class="modal-header border-bottom border-secondary">
                <h5 class="modal-title text-warning">Hoja de Vida</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="cvContent"></div>
            </div>
            <div class="modal-footer border-top border-secondary">
                <button type="button" class="btn btn-secondary" id="prevCandidate">Anterior</button>
                <button type="button" class="btn btn-secondary" id="nextCandidate">Siguiente</button>
                <button type="button" class="btn btn-warning" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos CSS -->
<style>
    .form-check-input:checked {
        background-color: #f8d047;
        border-color: #f8d047;
    }
    .selected-card {
        border: 2px solid #f8d047 !important;
    }
    .candidato-card {
        transition: transform 0.2s;
    }
    .candidato-card:hover {
        transform: translateY(-5px);
    }
    .card {
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .cv-section {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background-color: #282828;
        border-radius: 8px;
        color: #ffffff;
    }
    .cv-section h4 {
        color: #f8d047;
        margin-bottom: 1rem;
    }
    .modal-body strong {
        color: #f8d047;
    }
</style>

<!-- JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Código anterior del modal y filtros
        {{ previous_js|safe }}
    
        // Nuevo código para manejo de selección
        const checkboxes = document.querySelectorAll('.candidate-checkbox');
        const selectAllBtn = document.getElementById('selectAll');
        const deselectAllBtn = document.getElementById('deselectAll');
        const downloadBtn = document.getElementById('downloadExcel');
        const selectedCountSpan = document.getElementById('selectedCount');
        const selectedCandidatesInput = document.getElementById('selectedCandidates');
    
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.candidate-checkbox:checked').length;
            selectedCountSpan.textContent = `Seleccionados: ${selectedCount}`;
            downloadBtn.disabled = selectedCount === 0;
            
            // Actualizar el input hidden con los IDs seleccionados
            const selectedIds = Array.from(document.querySelectorAll('.candidate-checkbox:checked'))
                .map(checkbox => checkbox.value);
            selectedCandidatesInput.value = JSON.stringify(selectedIds);
    
            // Actualizar visual de las tarjetas
            checkboxes.forEach(checkbox => {
                const card = checkbox.closest('.card');
                if (checkbox.checked) {
                    card.classList.add('selected-card');
                } else {
                    card.classList.remove('selected-card');
                }
            });
        }
    
        // Event listeners para los checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
    
        // Botón Seleccionar Todo
        selectAllBtn.addEventListener('click', () => {
            checkboxes.forEach(checkbox => {
                const card = checkbox.closest('.candidato-card');
                if (card.style.display !== 'none') { // Solo seleccionar los visibles
                    checkbox.checked = true;
                }
            });
            updateSelectedCount();
        });
    
        // Botón Deseleccionar Todo
        deselectAllBtn.addEventListener('click', () => {
            checkboxes.forEach(checkbox => checkbox.checked = false);
            updateSelectedCount();
        });
    
        // Actualizar selección cuando se filtran las tarjetas
        const originalFilterCandidatos = filterCandidatos;
        function newFilterCandidatos() {
            originalFilterCandidatos();
            updateSelectedCount();
        }
        filterCandidatos = newFilterCandidatos;
    
        // Inicializar conteo
        updateSelectedCount();
    });
    
</script>
{% endblock %}